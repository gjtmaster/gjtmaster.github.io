<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="心有多大，舞台就有多大！"><title>kafka rebalance机制与Consumer多种消费模式案例 | Joker's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kafka rebalance机制与Consumer多种消费模式案例</h1><a id="logo" href="/.">Joker's Blog</a><p class="description">高金涛</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">kafka rebalance机制与Consumer多种消费模式案例</h1><div class="post-meta">Sep 17, 2018<span> | </span><span class="category"><a href="/categories/消息中间件/">消息中间件</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#rebalance-何时触发？到底干嘛？流程如何？"><span class="toc-number">1.</span> <span class="toc-text">rebalance 何时触发？到底干嘛？流程如何？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#reblance-何时触发"><span class="toc-number">1.1.</span> <span class="toc-text">reblance 何时触发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reblance-到底干嘛"><span class="toc-number">1.2.</span> <span class="toc-text">reblance 到底干嘛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Coordinator-到底在那个Broker"><span class="toc-number">1.3.</span> <span class="toc-text">Coordinator 到底在那个Broker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reblance-流程如何"><span class="toc-number">1.4.</span> <span class="toc-text">reblance 流程如何</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reblance-机制的好处"><span class="toc-number">1.5.</span> <span class="toc-text">reblance 机制的好处</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reblance-generation-过滤无用请求"><span class="toc-number">1.6.</span> <span class="toc-text">reblance generation 过滤无用请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#reblance-监听器应用级别实战"><span class="toc-number">2.</span> <span class="toc-text">reblance 监听器应用级别实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Consumer组内消息均衡实战"><span class="toc-number">3.</span> <span class="toc-text">Consumer组内消息均衡实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer-单线程封装，实现多个消费者来消费（浪费资源）"><span class="toc-number">3.1.</span> <span class="toc-text">Consumer 单线程封装，实现多个消费者来消费（浪费资源）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一个Consumer，内部实现多线程消费（consumer压力过大）"><span class="toc-number">3.2.</span> <span class="toc-text">一个Consumer，内部实现多线程消费（consumer压力过大）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方案对比"><span class="toc-number">3.3.</span> <span class="toc-text">方案对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Consumer指定分区消费案例实战（Standalone-Consumer）"><span class="toc-number">3.4.</span> <span class="toc-text">Consumer指定分区消费案例实战（Standalone  Consumer）</span></a></li></ol></li></ol></div></div><div class="post-content"><h2 id="rebalance-何时触发？到底干嘛？流程如何？"><a href="#rebalance-何时触发？到底干嘛？流程如何？" class="headerlink" title="rebalance 何时触发？到底干嘛？流程如何？"></a>rebalance 何时触发？到底干嘛？流程如何？</h2><h3 id="reblance-何时触发"><a href="#reblance-何时触发" class="headerlink" title="reblance 何时触发"></a>reblance 何时触发</h3><ul>
<li>组订阅发生变更，比如基于正则表达式订阅，当匹配到新的topic创建时，组的订阅就会发生变更。</li>
<li>组的topic分区数发生变更，通过命令行脚本增加了订阅topic的分区数。</li>
<li>组成员发生变更：新加入组以及离开组。</li>
</ul>
<h3 id="reblance-到底干嘛"><a href="#reblance-到底干嘛" class="headerlink" title="reblance 到底干嘛"></a>reblance 到底干嘛</h3><p>一句话：多个Consumer订阅了一个Topic时，根据分区策略进行消费者订阅分区的重分配</p>
<h3 id="Coordinator-到底在那个Broker"><a href="#Coordinator-到底在那个Broker" class="headerlink" title="Coordinator 到底在那个Broker"></a>Coordinator 到底在那个Broker</h3><p>找到Coordinator的算法 与 找到_consumer_offsets目标分区的算法是一致的。</p>
<ul>
<li>第一步：确定目标分区：Math.abs(groupId.hashCode)%50，假设是12。</li>
<li>第二步：找到_consumer_offsets分区为10的Leader副本所在的Broker，那么该broker即为Group Coordinator。</li>
</ul>
<h3 id="reblance-流程如何"><a href="#reblance-流程如何" class="headerlink" title="reblance 流程如何"></a>reblance 流程如何</h3><p>reblance 流程流程整体如下图所示，值得强调的几点如下：</p>
<ul>
<li><p>Coordinator的角色由Broker端担任。</p>
</li>
<li><p>Group Leader 的角色主要有Consumer担任。</p>
</li>
<li><p>加入组请求（JoinGroup）=&gt;作用在于选择Group Leader。</p>
</li>
<li><p>同步组请求（SyncGroup）=&gt;作用在于确定分区分配方案给Coordinator，把方案响应给所有Consumer。</p>
</li>
</ul>
<h3 id="reblance-机制的好处"><a href="#reblance-机制的好处" class="headerlink" title="reblance 机制的好处"></a>reblance 机制的好处</h3><ul>
<li>分区分配权利下放给客户端consumer，因此系统不用重启，既可以实现分区策略的变更。</li>
<li>用户可以自行实现机架感知分配方案。</li>
</ul>
<h3 id="reblance-generation-过滤无用请求"><a href="#reblance-generation-过滤无用请求" class="headerlink" title="reblance generation 过滤无用请求"></a>reblance generation 过滤无用请求</h3><ul>
<li>kafka引入 reblance generation ，就是为了防止Consumer group的无效Offset提交。若因为某些原因，consumer延迟提交了Offset，而该consumer被踢出了消费组，那么该Consumer再次提交位移时，携带的就是旧的generation了。</li>
</ul>
<h2 id="reblance-监听器应用级别实战"><a href="#reblance-监听器应用级别实战" class="headerlink" title="reblance 监听器应用级别实战"></a>reblance 监听器应用级别实战</h2><ul>
<li><p>reblance 监听器解决用户   把位移提交到外部存储的情况，在监听器中实现位移保存和位移的重定向。</p>
</li>
<li><p>onPartitionsRevoked :  rebalance开启新一轮的重平衡前会调用，一般用于手动提交位移，及审计功能</p>
</li>
<li><p>onPartitionsAssigned ：rebalance在重平衡结束后会调用，一般用于消费逻辑处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"> Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line"> props.put(<span class="string">"bootstrap.servers"</span>, <span class="string">"localhost:9092"</span>);</span><br><span class="line"> props.put(<span class="string">"group.id"</span>, <span class="string">"test"</span>);</span><br><span class="line"> props.put(<span class="string">"enable.auto.commit"</span>, <span class="string">"false"</span>);</span><br><span class="line"> props.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line"> props.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line"> KafkaConsumer&lt;String, String&gt; consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</span><br><span class="line"> </span><br><span class="line"> 统计rebalance总时长</span><br><span class="line"> <span class="keyword">final</span> AtomicLong totalRebalanceTimeMs =<span class="keyword">new</span> AtomicLong(<span class="number">0L</span>)</span><br><span class="line"> </span><br><span class="line"> 统计rebalance开始时刻</span><br><span class="line"> <span class="keyword">final</span> AtomicLong rebalanceStart =<span class="keyword">new</span> AtomicLong(<span class="number">0L</span>)</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> <span class="number">1</span> 重平衡监听</span><br><span class="line"> consumer.subscribe(Arrays.asList(<span class="string">"test-topic"</span>), <span class="keyword">new</span> ConsumerRebalanceListener()&#123;</span><br><span class="line">     </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPartitionsRevoked</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(TopicPartition tp : partitions)&#123;</span><br><span class="line">        </span><br><span class="line">            <span class="number">1</span> 保存到外部存储</span><br><span class="line">            saveToExternalStore(consumer.position(tp)) </span><br><span class="line">            </span><br><span class="line">            <span class="number">2</span> 手动提交位移</span><br><span class="line">            <span class="comment">//consumer.commitSync(toCommit);</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        rebalanceStart.set(System.currentTimeMillis())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPartitionsAssigned</span><span class="params">(Collection&lt;TopicPartition&gt; partitions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    totalRebalanceTimeMs.addAndGet(System.currentTimeMillis()-rebalanceStart.get())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (TopicPartition tp : partitions) &#123;</span><br><span class="line">           </span><br><span class="line">           consumer.seek(tp，readFromExternalStore(tp))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 消息处理</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"> ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="number">100</span>);</span><br><span class="line"> <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">     buffer.add(record);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">if</span> (buffer.size() &gt;= minBatchSize) &#123;</span><br><span class="line">     insertIntoDb(buffer);</span><br><span class="line">     consumer.commitSync();</span><br><span class="line">     buffer.clear();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="Consumer组内消息均衡实战"><a href="#Consumer组内消息均衡实战" class="headerlink" title="Consumer组内消息均衡实战"></a>Consumer组内消息均衡实战</h2><h3 id="Consumer-单线程封装，实现多个消费者来消费（浪费资源）"><a href="#Consumer-单线程封装，实现多个消费者来消费（浪费资源）" class="headerlink" title="Consumer 单线程封装，实现多个消费者来消费（浪费资源）"></a>Consumer 单线程封装，实现多个消费者来消费（浪费资源）</h3><p>实例主题：</p>
<ul>
<li>ConsumerGroup 实现组封装</li>
<li>ConsumerRunnable 每个线程维护私有的KafkaConsumer实例</li>
</ul>
<hr>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span>  <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> void main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">        <span class="keyword">String</span> brokerList = <span class="string">"localhost:9092"</span>;</span><br><span class="line">        <span class="keyword">String</span> groupId = <span class="string">"testGroup1"</span>;</span><br><span class="line">        <span class="keyword">String</span> topic = <span class="string">"test-topic"</span>;</span><br><span class="line">        int consumerNum = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">        核心对外封装</span><br><span class="line">        ConsumerGroup consumerGroup = <span class="keyword">new</span> <span class="type">ConsumerGroup</span>(consumerNum, groupId, topic, brokerList);</span><br><span class="line">        consumerGroup.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerGroup</span> </span>&#123;    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;ConsumerRunnable&gt; consumers;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ConsumerGroup(int consumerNum, <span class="keyword">String</span> groupId, <span class="keyword">String</span> topic, <span class="keyword">String</span> brokerList) &#123;</span><br><span class="line">        consumers = <span class="keyword">new</span> <span class="type">ArrayList</span>&lt;&gt;(consumerNum);</span><br><span class="line">        <span class="keyword">for</span> (int i = <span class="number">0</span>; i &lt; consumerNum; ++i) &#123;</span><br><span class="line">            ConsumerRunnable consumerThread = <span class="keyword">new</span> <span class="type">ConsumerRunnable</span>(brokerList, groupId, topic);</span><br><span class="line">            consumers.add(consumerThread);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> void execute() &#123;</span><br><span class="line">        <span class="keyword">for</span> (ConsumerRunnable task : <span class="type">consumers</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="type">Thread</span>(task).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecords;</span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.KafkaConsumer;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class ConsumerRunnable implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final KafkaConsumer&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; consumer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConsumerRunnable(<span class="keyword">String</span> brokerList, <span class="keyword">String</span> groupId, <span class="keyword">String</span> topic) &#123;</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"bootstrap.servers"</span>, brokerList);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"group.id"</span>, groupId);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"enable.auto.commit"</span>, <span class="string">"true"</span>);        <span class="comment">//本例使用自动提交位移</span></span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"session.timeout.ms"</span>, <span class="string">"30000"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        <span class="keyword">this</span>.consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</span><br><span class="line">        consumer.subscribe(Arrays.asList(topic));   <span class="comment">// 本例使用分区副本自动分配策略</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>() &#123;</span><br><span class="line">        <span class="built_in">while</span> (true) &#123;</span><br><span class="line">            ConsumerRecords&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; records = consumer.poll(<span class="number">200</span>);   </span><br><span class="line">            <span class="built_in">for</span> (ConsumerRecord&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; record : records) &#123;</span><br><span class="line">                System.out.<span class="built_in">println</span>(Thread.currentThread().getName() + <span class="string">" consumed "</span> + record.partition() +</span><br><span class="line">                        <span class="string">"th message with offset: "</span> + record.offset());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="一个Consumer，内部实现多线程消费（consumer压力过大）"><a href="#一个Consumer，内部实现多线程消费（consumer压力过大）" class="headerlink" title="一个Consumer，内部实现多线程消费（consumer压力过大）"></a>一个Consumer，内部实现多线程消费（consumer压力过大）</h3><p>实例主题：</p>
<ul>
<li>ConsumerHandler 单一的Consumer实例，poll后里面会跑一个线程池，执行多个Processor线程来处理</li>
<li>Processor 业务逻辑处理方法</li>
</ul>
<p>进一步优化建议；</p>
<ul>
<li>ConsumerHandler 设置手动提交位移，负责最终位移提交consumer.commitSync();。</li>
<li>ConsumerHandler设置一个全局的Map&lt;TopicPartion,OffsetAndMetadata&gt; offsets，来管理Processor消费的位移。</li>
<li>Processor 负责批处理完消息后，得到消息的最大位移，并更新offsets数组</li>
<li>ConsumerHandler 根据 offsets，位移提交后会清空offsets集合。</li>
<li>ConsumerHandler设置重平衡监听</li>
</ul>
<hr>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> class Main &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="keyword">String</span>[] args) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">String</span> brokerList = <span class="string">"localhost:9092,localhost:9093,localhost:9094"</span>;</span><br><span class="line">        <span class="keyword">String</span> groupId = <span class="string">"group2"</span>;</span><br><span class="line">        <span class="keyword">String</span> topic = <span class="string">"test-topic"</span>;</span><br><span class="line">        <span class="keyword">int</span> workerNum = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        ConsumerHandler consumers = <span class="keyword">new</span> ConsumerHandler(brokerList, groupId, topic);</span><br><span class="line">        consumers.execute(workerNum);</span><br><span class="line">        <span class="built_in">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">        &#125; <span class="built_in">catch</span> (InterruptedException ignored) &#123;&#125;</span><br><span class="line">        consumers.<span class="built_in">shutdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ArrayBlockingQueue;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ExecutorService;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> class ConsumerHandler &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> final KafkaConsumer&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; consumer;</span><br><span class="line">    <span class="keyword">private</span> ExecutorService executors;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConsumerHandler(<span class="keyword">String</span> brokerList, <span class="keyword">String</span> groupId, <span class="keyword">String</span> topic) &#123;</span><br><span class="line">        Properties props = <span class="keyword">new</span> Properties();</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"bootstrap.servers"</span>, brokerList);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"group.id"</span>, groupId);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"enable.auto.commit"</span>, <span class="string">"true"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"session.timeout.ms"</span>, <span class="string">"30000"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        props.<span class="built_in">put</span>(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">        consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</span><br><span class="line">        consumer.subscribe(Arrays.asList(topic));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> execute(<span class="keyword">int</span> workerNum) &#123;</span><br><span class="line">    </span><br><span class="line">        executors = <span class="keyword">new</span> ThreadPoolExecutor(workerNum, workerNum, <span class="number">0</span>L, TimeUnit.MILLISECONDS,</span><br><span class="line">                <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">1000</span>), <span class="keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());</span><br><span class="line">                </span><br><span class="line">        <span class="built_in">while</span> (true) &#123;</span><br><span class="line">            ConsumerRecords&lt;<span class="keyword">String</span>, <span class="keyword">String</span>&gt; records = consumer.poll(<span class="number">200</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="built_in">for</span> (final ConsumerRecord record : records) &#123;</span><br><span class="line">                executors.submit(<span class="keyword">new</span> Processor(record));</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">shutdown</span>() &#123;</span><br><span class="line">        <span class="built_in">if</span> (consumer != null) &#123;</span><br><span class="line">            consumer.<span class="built_in">close</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">if</span> (executors != null) &#123;</span><br><span class="line">            executors.<span class="built_in">shutdown</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">try</span> &#123;</span><br><span class="line">            <span class="built_in">if</span> (!executors.awaitTermination(<span class="number">10</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                System.out.<span class="built_in">println</span>(<span class="string">"Timeout.... Ignore for this case"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="built_in">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">            System.out.<span class="built_in">println</span>(<span class="string">"Other thread interrupted this shutdown, ignore for this case."</span>);</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.kafka.clients.consumer.ConsumerRecord;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Processor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ConsumerRecord&lt;String, String&gt; consumerRecord;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Processor</span><span class="params">(ConsumerRecord record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.consumerRecord = record;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">" consumed "</span> + consumerRecord.partition()</span><br><span class="line">            + <span class="string">"th message with offset: "</span> + consumerRecord.offset());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="方案对比"><a href="#方案对比" class="headerlink" title="方案对比"></a>方案对比</h3><ul>
<li>第一种方案：建议采用 Consumer 单线程封装，实现多个消费者来消费（浪费资源），这样能很好地保证分区内消费的顺序，同时也没有线程切换的开销。</li>
<li>第二种方案：实现复杂，问题在于可能无法维护分区内的消息顺序，注意消息处理和消息接收解耦了。</li>
</ul>
<h3 id="Consumer指定分区消费案例实战（Standalone-Consumer）"><a href="#Consumer指定分区消费案例实战（Standalone-Consumer）" class="headerlink" title="Consumer指定分区消费案例实战（Standalone  Consumer）"></a>Consumer指定分区消费案例实战（Standalone  Consumer）</h3><ul>
<li><p>Standalone Consumer  assign 用于接收指定分区列表的消息和Subscribe是矛盾的。只能二选一。</p>
</li>
<li><p>多个 Consumer 实例消费一个 Topic 借助于 group reblance可谓是天作之合。</p>
</li>
<li><p>若要精准控制，assign逃不了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">poperties props = <span class="keyword">new</span> Properties();</span><br><span class="line">props.put(<span class="string">"bootstrap.servers"</span>, brokerList);</span><br><span class="line">props.put(<span class="string">"group.id"</span>, groupId);</span><br><span class="line">props.put(<span class="string">"enable.auto.commit"</span>, <span class="string">"false"</span>);</span><br><span class="line">props.put(<span class="string">"auto.commit.interval.ms"</span>, <span class="string">"1000"</span>);</span><br><span class="line">props.put(<span class="string">"session.timeout.ms"</span>, <span class="string">"30000"</span>);</span><br><span class="line">props.put(<span class="string">"key.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">props.put(<span class="string">"value.deserializer"</span>, <span class="string">"org.apache.kafka.common.serialization.StringDeserializer"</span>);</span><br><span class="line">consumer = <span class="keyword">new</span> KafkaConsumer&lt;&gt;(props);</span><br><span class="line"></span><br><span class="line">List&lt;TopicPartion&gt; partitions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">List&lt;PartitionInfo&gt;  allPartitions = consumer.partitionsFor(<span class="string">"kaiXinTopic"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(allPartitions != <span class="keyword">null</span> &amp;&amp; !allPartitions.isEmpty)&#123;</span><br><span class="line">    <span class="keyword">for</span>(PartitionInfo partitionInfo : allPartitions)&#123;</span><br><span class="line">    </span><br><span class="line">        partitions.add(<span class="keyword">new</span> TopicPartition(partitionInfo.topic(),partitionInfo.partition()))</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    consumer.assign(partitions)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">   ConsumerRecords&lt;String, String&gt; records = consumer.poll(<span class="number">100</span>);</span><br><span class="line">   <span class="keyword">for</span> (ConsumerRecord&lt;String, String&gt; record : records) &#123;</span><br><span class="line">       buffer.add(record);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (buffer.size() &gt;= minBatchSize) &#123;</span><br><span class="line">       insertIntoDb(buffer);</span><br><span class="line">       </span><br><span class="line">       consumer.commitSync();</span><br><span class="line">       </span><br><span class="line">       buffer.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>gaojintao999@163.com</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2018/09/17/kafka rebalance 机制与Consumer多种消费模式案例应用实战/">https://gjtmaster.github.io/2018/09/17/kafka rebalance 机制与Consumer多种消费模式案例应用实战/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>The author owns the copyright, please indicate the source reproduced.</li></ul></div><br><div class="tags"><a href="/tags/Kafka/">Kafka</a><a href="/tags/消息中间件/">消息中间件</a></div><div class="post-nav"><a class="pre" href="/2018/09/18/FlinkSQL深度解析/">Flink SQL 深度解析</a><a class="next" href="/2018/09/16/kafka Poll轮询机制与消费者组的重平衡分区策略剖析/">kafka Poll轮询机制与消费者组的重平衡分区策略剖析</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/实时计算框架/">实时计算框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据存储格式/">数据存储格式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据的导入导出/">数据的导入导出</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志框架/">日志框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/消息中间件/">消息中间件</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Oracle/" style="font-size: 15px;">Oracle</a> <a href="/tags/Flink/" style="font-size: 15px;">Flink</a> <a href="/tags/Yarn/" style="font-size: 15px;">Yarn</a> <a href="/tags/实时计算/" style="font-size: 15px;">实时计算</a> <a href="/tags/Flink-on-Yarn/" style="font-size: 15px;">Flink on Yarn</a> <a href="/tags/Kafka/" style="font-size: 15px;">Kafka</a> <a href="/tags/消息中间件/" style="font-size: 15px;">消息中间件</a> <a href="/tags/FlinkSQL/" style="font-size: 15px;">FlinkSQL</a> <a href="/tags/Logback/" style="font-size: 15px;">Logback</a> <a href="/tags/Json/" style="font-size: 15px;">Json</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/内存回收/" style="font-size: 15px;">内存回收</a> <a href="/tags/ogg/" style="font-size: 15px;">ogg</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/19/Flink 进阶：Time 深度解析/">Flink 进阶：Time 深度解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/19/Flink 进阶：Flink Connector详解/">Flink 进阶：Flink Connector详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/16/Flink 进阶：增量 Checkpoint 详解/">Flink 进阶：增量 Checkpoint 详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/15/Flink 进阶：Runtime 核心机制剖析/">Flink 进阶：Runtime 核心机制剖析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/15/Flink1.7.1与Kafka0.11.0.1/">Flink1.7.1与Kafka0.11.0.1</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/10/Flink on Yarn HA/">Flink On Yarn HA</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/15/Flink On Yan集群部署/">Flink On Yarn集群部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/13/Flink使用Logback作为日志框架的相关配置/">Flink使用Logback作为日志框架的相关配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/18/FlinkSQL深度解析/">Flink SQL 深度解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/17/kafka rebalance 机制与Consumer多种消费模式案例应用实战/">kafka rebalance机制与Consumer多种消费模式案例</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://matt33.com/" title="Matt's Blog" target="_blank">Matt's Blog</a><ul></ul><a href="https://www.haomwei.com/technology/maupassant-hexo.html" title="Maupassant's usage" target="_blank">Maupassant's usage</a><ul></ul><a href="https://www.jianshu.com/p/f4332764e8bd" title="hexo's usage" target="_blank">hexo's usage</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Joker's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>