<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="心有多大，舞台就有多大！"><title>测试文章 | Joker's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">测试文章</h1><a id="logo" href="/.">Joker's Blog</a><p class="description">高金涛</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/history/"><i class="fa fa-history"> 历史</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">测试文章</h1><div class="post-meta">Jul 8, 2019<span> | </span><span class="category"><a href="/categories/测试/">测试</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 4.5k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 21</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SUPPLE"><span class="toc-number">1.</span> <span class="toc-text">SUPPLE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SUPPLE-1"><span class="toc-number">2.</span> <span class="toc-text">SUPPLE</span></a></li></ol></div></div><div class="post-content"><p>利用ogg实现oracle到kafka的增量数据实时同步<br>前言</p>
<p>ogg即Oracle GoldenGate是Oracle的同步工具，本文讲如何配置ogg以实现Oracle数据库增量数据实时同步到kafka中，其中同步消息格式为json。<br>下面是我的源端和目标端的一些配置信息：</p>
<ul>
<li>版本    OGG版本    ip    别名<br>源端    OracleRelease 11.2.0.1.0    Oracle GoldenGate 11.2.1.0.3 for Oracle on Linux x86-64    192.168.44.128    master<br>目标端    kafka_2.11-1.1.0    Oracle GoldenGate for Big Data 12.3.1.1.1 on Linux x86-64    192.168.44.129    slave1<br>1、下载</li>
</ul>
<p>可在这里或旧版本查询下载<br>注意：源端和目标端的文件不一样，目标端需要下载Oracle GoldenGate for Big Data,源端需要下载Oracle GoldenGate for Oracle具体下载方法见最后的附录截图。</p>
<p>2、源端（Oracle）配置</p>
<p>注意：源端是安装了oracle的机器，oracle环境变量之前都配置好了</p>
<p>2.1 解压</p>
<p>先建立ogg目录</p>
<p>mkdir -p /opt/ogg<br>unzip V34339-01.zip<br>解压后得到一个tar包，再解压这个tar</p>
<p>tar xf fbo_ggs_Linux_x64_ora11g_64bit.tar -C /opt/ogg<br>chown -R oracle:oinstall /opt/ogg （使oracle用户有ogg的权限，后面有些需要在oracle用户下执行才能成功）<br>2.2 配置ogg环境变量</p>
<p>为了简单方便起见，我在/etc/profile里配置的，建议在生产中配置oracle的环境变量文件/home/oracle/.bash_profile里配置，为了怕出问题，我把OGG_HOME等环境变量在/etc/profile配置了一份，不知道这是否是必须的。</p>
<p>vim /etc/profile</p>
<p>export OGG_HOME=/opt/ogg<br>export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib<br>export PATH=$OGG_HOME:$PATH<br>使之生效</p>
<p>source /etc/profile<br>测试一下ogg命令</p>
<p>ggsci<br>如果命令成功即可进行下一步，不成功请检查前面的步骤。</p>
<p>2.3 oracle打开归档模式</p>
<p>su - oracle<br>sqlplus / as sysdba<br>执行下面的命令查看当前是否为归档模式</p>
<p>archive log list</p>
<p>SQL&gt; archive log list<br>Database log mode          No Archive Mode<br>Automatic archival         Disabled<br>Archive destination        USE_DB_RECOVERY_FILE_DEST<br>Oldest online log sequence     12<br>Current log sequence           14<br>若为Disabled，手动打开即可</p>
<p>conn / as sysdba (以DBA身份连接数据库)<br>shutdown immediate (立即关闭数据库)<br>startup mount (启动实例并加载数据库，但不打开)<br>alter database archivelog; (更改数据库为归档模式)<br>alter database open; (打开数据库)<br>alter system archive log start; (启用自动归档)<br>再执行一下</p>
<p>archive log list</p>
<p>Database log mode          Archive Mode<br>Automatic archival         Enabled<br>Archive destination        USE_DB_RECOVERY_FILE_DEST<br>Oldest online log sequence     12<br>Next log sequence to archive   14<br>Current log sequence           14<br>可以看到为Enabled，则成功打开归档模式。</p>
<p>2.4 Oracle打开日志相关</p>
<p>OGG基于辅助日志等进行实时传输，故需要打开相关日志确保可获取事务内容，通过下面的命令查看该状态</p>
<p>select force_logging, supplemental_log_data_min from v$database;</p>
<p>FORCE_ SUPPLEMENTAL_LOG</p>
<hr>
<p>NO     NO<br>若为NO，则需要通过命令修改</p>
<p>alter database force logging;<br>alter database add supplemental log data;<br>再查看一下为YES即可</p>
<p>SQL&gt; select force_logging, supplemental_log_data_min from v$database;<br>​<br>FORCE_ SUPPLEMENTAL_LOG</p>
<hr>
<p>YES    YES<br>2.5 oracle创建复制用户</p>
<p>首先root用户建立相关文件夹，并赋予权限</p>
<p>mkdir -p /u01/app/oracle/oggdata/orcl<br>chown -R oracle:oinstall /u01/app/oracle/oggdata/orcl<br>然后执行下面sql</p>
<p>SQL&gt; create tablespace oggtbs datafile ‘/u01/app/oracle/oggdata/orcl/oggtbs01.dbf’ size 1000M autoextend on;<br>Tablespace created.<br>​<br>SQL&gt;  create user ogg identified by ogg default tablespace oggtbs;<br>User created.<br>​<br>SQL&gt; grant dba to ogg;<br>Grant succeeded.<br>2.6 OGG初始化</p>
<p>ggsci<br>create subdirs</p>
<p>ggsci<br>​<br>Oracle GoldenGate Command Interpreter for Oracle<br>Version 11.2.1.0.3 14400833 OGGCORE_11.2.1.0.3_PLATFORMS_120823.1258_FBO<br>Linux, x64, 64bit (optimized), Oracle 11g on Aug 23 2012 20:20:21<br>​<br>Copyright (C) 1995, 2012, Oracle and/or its affiliates. All rights reserved.<br>​<br>​<br>​<br>GGSCI (ambari.master.com) 1&gt; create subdirs<br>​<br>Creating subdirectories under current directory /root<br>​<br>Parameter files                /root/dirprm: created<br>Report files                   /root/dirrpt: created<br>Checkpoint files               /root/dirchk: created<br>Process status files           /root/dirpcs: created<br>SQL script files               /root/dirsql: created<br>Database definitions files     /root/dirdef: created<br>Extract data files             /root/dirdat: created<br>Temporary files                /root/dirtmp: created<br>Stdout files                   /root/dirout: created<br>​<br>​<br>GGSCI (ambari.master.com) 2&gt;<br>2.7 Oracle创建测试表</p>
<p>创建一个用户,在该用户下新建测试表，用户名、密码、表名均为 test_ogg。</p>
<p>create user test_ogg  identified by test_ogg default tablespace users;<br>grant dba to test_ogg;<br>conn test_ogg/test_ogg;<br>create table test_ogg(id int ,name varchar(20),primary key(id));<br>3 目标端（kafka）配置</p>
<p>mkdir -p /opt/ogg<br>unzip 123111_ggs_Adapters_Linux_x64.zip<br>tar xf ggs_Adapters_Linux_x64.tar  -C /opt/ogg/<br>3.2 环境变量</p>
<p>vim /etc/profile</p>
<p>export OGG_HOME=/opt/ogg<br>export LD_LIBRARY_PATH=$JAVA_HOME/jre/lib/amd64:$JAVA_HOME/jre/lib/amd64/server:$JAVA_HOME/jre/lib/amd64/libjsig.so:$JAVA_HOME/jre/lib/amd64/server/libjvm.so:$OGG_HOME/lib<br>export PATH=$OGG_HOME:$PATH</p>
<p>source /etc/profile<br>同样测试一下ogg命令</p>
<p>ggsci<br>3.3 初始化目录</p>
<p>create subdirs<br>4、OGG源端配置</p>
<p>4.1 配置OGG的全局变量</p>
<p>先切换到oracle用户下</p>
<p>su oracle<br>cd /opt/ogg<br>ggsci</p>
<p>GGSCI (ambari.master.com) 1&gt; dblogin userid ogg password ogg<br>Successfully logged into database.<br>​<br>GGSCI (ambari.master.com) 2&gt; edit param ./globals<br>然后和用vim编辑一样添加</p>
<p>oggschema ogg<br>4.2 配置管理器mgr</p>
<p>GGSCI (ambari.master.com) 3&gt; edit param mgr<br>PORT 7809<br>DYNAMICPORTLIST 7810-7909<br>AUTORESTART EXTRACT <em>,RETRIES 5,WAITMINUTES 3<br>PURGEOLDEXTRACTS ./dirdat/</em>,usecheckpoints, minkeepdays 3<br>说明：PORT即mgr的默认监听端口；DYNAMICPORTLIST动态端口列表，当指定的mgr端口不可用时，会在这个端口列表中选择一个，最大指定范围为256个；AUTORESTART重启参数设置表示重启所有EXTRACT进程，最多5次，每次间隔3分钟；PURGEOLDEXTRACTS即TRAIL文件的定期清理</p>
<p>4.3 添加复制表</p>
<p>GGSCI (ambari.master.com) 4&gt; add trandata test_ogg.test_ogg</p>
<p>Logging of supplemental redo data enabled for table TEST_OGG.TEST_OGG.</p>
<p>GGSCI (ambari.master.com) 5&gt; info trandata test_ogg.test_ogg</p>
<p>Logging of supplemental redo log data is enabled for table TEST_OGG.TEST_OGG.</p>
<p>Columns supplementally logged for table TEST_OGG.TEST_OGG: ID</p>
<p>4.4 配置extract进程</p>
<p>GGSCI (ambari.master.com) 6&gt; edit param extkafka<br>extract extkafka<br>dynamicresolution<br>SETENV (ORACLE_SID = “orcl”)<br>SETENV (NLS_LANG = “american_america.AL32UTF8”)<br>userid ogg,password ogg<br>exttrail /opt/ogg/dirdat/to<br>table test_ogg.test_ogg;<br>说明：第一行指定extract进程名称；dynamicresolution动态解析；SETENV设置环境变量，这里分别设置了Oracle数据库以及字符集；userid ggs,password ggs即OGG连接Oracle数据库的帐号密码，这里使用2.5中特意创建的复制帐号；exttrail定义trail文件的保存位置以及文件名，注意这里文件名只能是2个字母，其余部分OGG会补齐；table即复制表的表名，支持*通配，必须以;结尾</p>
<p>添加extract进程：</p>
<p>GGSCI (ambari.master.com) 16&gt; add extract extkafka,tranlog,begin now<br>EXTRACT added.<br>(注：若报错</p>
<p>ERROR: Could not create checkpoint file /opt/ogg/dirchk/EXTKAFKA.cpe (error 2, No such file or directory).<br>执行下面的命令再重新添加即可。</p>
<p>create subdirs<br>)</p>
<p>添加trail文件的定义与extract进程绑定：</p>
<p>GGSCI (ambari.master.com) 17&gt; add exttrail /opt/ogg/dirdat/to,extract extkafka<br>EXTTRAIL added.<br>4.5 配置pump进程</p>
<p>pump进程本质上来说也是一个extract，只不过他的作用仅仅是把trail文件传递到目标端，配置过程和extract进程类似，只是逻辑上称之为pump进程</p>
<p>GGSCI (ambari.master.com) 18&gt; edit param pukafka<br>extract pukafka<br>passthru<br>dynamicresolution<br>userid ogg,password ogg<br>rmthost 192.168.44.129 mgrport 7809<br>rmttrail /opt/ogg/dirdat/to<br>table test_ogg.test_ogg;<br>说明：第一行指定extract进程名称；passthru即禁止OGG与Oracle交互，我们这里使用pump逻辑传输，故禁止即可；dynamicresolution动态解析；userid ogg,password ogg即OGG连接Oracle数据库的帐号密码rmthost和mgrhost即目标端(kafka)OGG的mgr服务的地址以及监听端口；rmttrail即目标端trail文件存储位置以及名称。</p>
<p>分别将本地trail文件和目标端的trail文件绑定到extract进程：</p>
<p>GGSCI (ambari.master.com) 1&gt; add extract pukafka,exttrailsource /opt/ogg/dirdat/to<br>EXTRACT added.<br>GGSCI (ambari.master.com) 2&gt; add rmttrail /opt/ogg/dirdat/to,extract pukafka<br>RMTTRAIL added.<br>4.6 配置define文件</p>
<p>Oracle与MySQL，Hadoop集群（HDFS，Hive，kafka等）等之间数据传输可以定义为异构数据类型的传输，故需要定义表之间的关系映射，在OGG命令行执行：</p>
<p>GGSCI (ambari.master.com) 3&gt; edit param test_ogg<br>defsfile /opt/ogg/dirdef/test_ogg.test_ogg<br>userid ogg,password ogg<br>table test_ogg.test_ogg;<br>在OGG主目录下执行(oracle用户)：</p>
<p>./defgen paramfile dirprm/test_ogg.prm</p>
<hr>
<pre><code>Oracle GoldenGate Table Definition Generator for Oracle</code></pre><p> Version 11.2.1.0.3 14400833 OGGCORE_11.2.1.0.3_PLATFORMS_120823.1258<br>   Linux, x64, 64bit (optimized), Oracle 11g on Aug 23 2012 16:58:29</p>
<p>Copyright (C) 1995, 2012, Oracle and/or its affiliates. All rights reserved.</p>
<pre><code>Starting at 2018-05-23 05:03:04</code></pre><hr>
<p>Operating System Version:<br>Linux<br>Version #1 SMP Wed Apr 12 15:04:24 UTC 2017, Release 3.10.0-514.16.1.el7.x86_64<br>Node: ambari.master.com<br>Machine: x86_64<br>                         soft limit   hard limit<br>Address Space Size   :    unlimited    unlimited<br>Heap Size            :    unlimited    unlimited<br>File Size            :    unlimited    unlimited<br>CPU Time             :    unlimited    unlimited</p>
<p>Process id: 13126</p>
<hr>
<p>**            Running with the following parameters                  **</p>
<hr>
<p>defsfile /opt/ogg/dirdef/test_ogg.test_ogg<br>userid ogg,password ***<br>table test_ogg.test_ogg;<br>Retrieving definition for TEST_OGG.TEST_OGG</p>
<p>Definitions generated for 1 table in /opt/ogg/dirdef/test_ogg.test_ogg</p>
<p>将生成的/opt/ogg/dirdef/test_ogg.test_ogg发送的目标端ogg目录下的dirdef里：</p>
<p>scp -r /opt/ogg/dirdef/test_ogg.test_ogg root@slave1:/opt/ogg/dirdef/</p>
<p>5、OGG目标端配置</p>
<p>5.1 开启kafka服务</p>
<p>cd /opt/kafka_2.11-1.1.0/<br>bin/zookeeper-server-start.sh config/zookeeper.properties<br>bin/kafka-server-start.sh config/server.properties<br>5.2 配置管理器mgr</p>
<p>GGSCI (ambari.slave1.com) 1&gt;  edit param mgr<br>PORT 7809<br>DYNAMICPORTLIST 7810-7909<br>AUTORESTART EXTRACT <em>,RETRIES 5,WAITMINUTES 3<br>PURGEOLDEXTRACTS ./dirdat/</em>,usecheckpoints, minkeepdays 3<br>5.3 配置checkpoint</p>
<p>checkpoint即复制可追溯的一个偏移量记录，在全局配置里添加checkpoint表即可。</p>
<p>edit  param  ./GLOBALS<br>CHECKPOINTTABLE test_ogg.checkpoint<br>5.4 配置replicate进程</p>
<p>GGSCI (ambari.slave1.com) 4&gt; edit param rekafka<br>REPLICAT rekafka<br>sourcedefs /opt/ogg/dirdef/test_ogg.test_ogg<br>TARGETDB LIBFILE libggjava.so SET property=dirprm/kafka.props<br>REPORTCOUNT EVERY 1 MINUTES, RATE<br>GROUPTRANSOPS 10000<br>MAP test_ogg.test_ogg, TARGET test_ogg.test_ogg;<br>说明：REPLICATE rekafka定义rep进程名称；sourcedefs即在4.6中在源服务器上做的表映射文件；TARGETDB LIBFILE即定义kafka一些适配性的库文件以及配置文件，配置文件位于OGG主目录下的dirprm/kafka.props；REPORTCOUNT即复制任务的报告生成频率；GROUPTRANSOPS为以事务传输时，事务合并的单位，减少IO操作；MAP即源端与目标端的映射关系</p>
<p>5.5 配置kafka.props</p>
<p>cd /opt/ogg/dirprm/<br>vim kafka.props<br>gg.handlerlist=kafkahandler //handler类型<br>gg.handler.kafkahandler.type=kafka<br>gg.handler.kafkahandler.KafkaProducerConfigFile=custom_kafka_producer.properties //kafka相关配置<br>gg.handler.kafkahandler.topicMappingTemplate=test_ogg //kafka的topic名称，无需手动创建<br>gg.handler.kafkahandler.format=json //传输文件的格式，支持json，xml等<br>gg.handler.kafkahandler.mode=op  //OGG for Big Data中传输模式，即op为一次SQL传输一次，tx为一次事务传输一次<br>gg.classpath=dirprm/:/opt/kafka_2.11-1.1.0/libs/<em>:/opt/ogg/:/opt/ogg/lib/</em><br>vim custom_kafka_producer.properties<br>bootstrap.servers=192.168.44.129:9092 //kafkabroker的地址<br>acks=1<br>compression.type=gzip //压缩类型<br>reconnect.backoff.ms=1000 //重连延时<br>value.serializer=org.apache.kafka.common.serialization.ByteArraySerializer<br>key.serializer=org.apache.kafka.common.serialization.ByteArraySerializer<br>batch.size=102400<br>linger.ms=10000<br>其中需要将后面的注释去掉，ogg不识别注释，如果不去掉会报错</p>
<p>5.6 添加trail文件到replicate进程</p>
<p>GGSCI (ambari.slave1.com) 2&gt; add replicat rekafka exttrail /opt/ogg/dirdat/to,checkpointtable test_ogg.checkpoint<br>REPLICAT added.<br>6、测试</p>
<p>6.1 启动所有进程</p>
<p>在源端和目标端的OGG命令行下使用start [进程名]的形式启动所有进程。<br>启动顺序按照源mgr——目标mgr——源extract——源pump——目标replicate来完成。<br>全部需要在ogg目录下执行ggsci目录进入ogg命令行。<br>源端依次是</p>
<p>start mgr<br>start extkafka<br>start pukafka<br>目标端</p>
<p>start mgr<br>start rekafka<br>可以通过info all 或者info [进程名] 查看状态，所有的进程都为RUNNING才算成功<br>源端</p>
<p>GGSCI (ambari.master.com) 5&gt; info all</p>
<p>Program     Status      Group       Lag at Chkpt  Time Since Chkpt</p>
<p>MANAGER     RUNNING<br>EXTRACT     RUNNING     EXTKAFKA    04:50:21      00:00:03<br>EXTRACT     RUNNING     PUKAFKA     00:00:00      00:00:03</p>
<p>目标端</p>
<p>GGSCI (ambari.slave1.com) 3&gt; info all</p>
<p>Program     Status      Group       Lag at Chkpt  Time Since Chkpt</p>
<p>MANAGER     RUNNING<br>REPLICAT    RUNNING     REKAFKA     00:00:00      00:00:01</p>
<p>6.2 异常解决</p>
<p>如果有不是RUNNING可通过查看日志的方法检查解决问题，具体通过下面两种方法</p>
<p>vim ggser.log<br>或者ogg命令行,以rekafka进程为例</p>
<p>GGSCI (ambari.slave1.com) 2&gt; view report rekafka<br>列举其中我遇到的一个问题：<br>异常信息</p>
<p>SEVERE: Unable to set property on handler ‘kafkahandler’ (oracle.goldengate.handler.kafka.KafkaHandler). Failed to set property: TopicName:=”test_ogg” (class: oracle.goldengate.handler.kafka.KafkaHandler).<br>oracle.goldengate.util.ConfigException: Failed to set property: TopicName:=”test_ogg” (class: oracle.goldengate.handler.kafka.KafkaHandler).<br>at ……</p>
<p>具体原因是网上的教程是旧版的，设置topicName的属性为:</p>
<p>gg.handler.kafkahandler.topicName=test_ogg<br>新版的这样设置</p>
<p>gg.handler.kafkahandler.topicMappingTemplate=test_ogg<br>大家可根据自己的版本进行设置，附上stackoverflow原答案</p>
<p>I tried to move data from Oracle Database to Kafka using Golden gate adapter Version 12.3.0.1.0</p>
<p>In new version there is no topicname</p>
<p>The following resolves the topic name using the short table name<br>gg.handler.kafkahandler.topicMappingTemplate=test</p>
<p>In previous version we have gg.handler.kafkahandler.topicName=test</p>
<p>6.3 测试同步更新效果</p>
<p>现在源端执行sql语句</p>
<p>conn test_ogg/test_ogg<br>insert into test_ogg values(1,’test’);<br>commit;<br>update test_ogg set name=’zhangsan’ where id=1;<br>commit;<br>delete test_ogg where id=1;<br>commit;<br>查看源端trail文件状态</p>
<p>ls -l /opt/ogg/dirdat/to*<br>-rw-rw-rw- 1 oracle oinstall 1464 May 23 10:31 /opt/ogg/dirdat/to000000<br>查看目标端trail文件状态</p>
<p>ls -l /opt/ogg/dirdat/to*<br>-rw-r—– 1 root root 1504 May 23 10:31 /opt/ogg/dirdat/to000000<br>查看kafka是否自动建立对应的主题</p>
<p>bin/kafka-topics.sh –list –zookeeper localhost:2181<br>在列表中显示有test_ogg则表示没问题<br>通过消费者看是否有同步消息</p>
<p>bin/kafka-console-consumer.sh –bootstrap-server 192.168.44.129:9092 –topic test_ogg –from-beginning<br>{“table”:”TEST_OGG.TEST_OGG”,”op_type”:”I”,”op_ts”:”2018-05-23 10:31:28.000078”,”current_ts”:”2018-05-23T10:36:48.525000”,”pos”:”00000000000000001093”,”after”:{“ID”:1,”NAME”:”test”}}<br>{“table”:”TEST_OGG.TEST_OGG”,”op_type”:”U”,”op_ts”:”2018-05-23 10:31:36.000073”,”current_ts”:”2018-05-23T10:36:48.874000”,”pos”:”00000000000000001233”,”before”:{},”after”:{“ID”:1,”NAME”:”zhangsan”}}<br>{“table”:”TEST_OGG.TEST_OGG”,”op_type”:”D”,”op_ts”:”2018-05-23 10:31:43.000107”,”current_ts”:”2018-05-23T10:36:48.875000”,”pos”:”00000000000000001376”,”before”:{“ID”:1}}<br>显然，Oracle的数据已准实时同步到Kafka,格式为json,其中op_type代表操作类型，这个可配置，我没有配置则按默认的来，默认为</p>
<p>gg.handler.kafkahandler.format.insertOpKey = I<br>gg.handler.kafkahandler.format.updateOpKey = U<br>gg.handler.kafkahandler.format.deleteOpKey = D<br>before代表操作之前的数据，after代表操作后的数据，现在已经可以从kafka获取到同步的json数据了，后面可以用SparkStreaming和Storm等解析然后存到hadoop等大数据平台里</p>
<p>6.4 SparkStreaming测试消费同步消息</p>
<p>具体代码可参考Spark Streaming连接Kafka入门教程<br>下面附上消费成功的结果图</p>
<p>7、更新：后续遇到的问题</p>
<p>在后面的使用过程中发现上面同步到kafka的json数据中少一些我们想要的一些，下面讲一下我是如何解决的<br>首先建表：</p>
<p>CREATE TABLE “TCLOUD”.”T_OGG2”<br>   (    “ID” NUMBER(<em>,0),<br>    “TEXT_NAME” VARCHAR2(20),<br>    “AGE” NUMBER(</em>,0),<br>    “ADD” VARCHAR2(100),<br>    “IDD” VARCHAR2(100),<br>     CONSTRAINT “T_OGG2_PK” PRIMARY KEY (“ID”, “IDD”)</p>
<p>   )</p>
<p>为什么不用之前建的表，主要是之前的字段太少，不容易看出问题，现在主要是增加几个字段，然后id,idd是联合主键。<br>看一下按照之前的配置，同步到kafka的数据(截取部分数据)</p>
<p>{“table”:”TCLOUD.T_OGG2”,”op_type”:”I”,”op_ts”:”2018-05-31 11:46:09.512672”,”current_ts”:”2018-05-31T11:46:15.292000”,”pos”:”00000000000000001903”,”after”:{“ID”:4,”TEXT_NAME”:null,”AGE”:0,”ADD”:null,”IDD”:”8”}}<br>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 11:49:10.514549”,”current_ts”:”2018-05-31T11:49:16.450000”,”pos”:”00000000000000002227”,”before”:{},”after”:{“ID”:4,”TEXT_NAME”:”lisi”,”IDD”:”7”}}<br>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 11:49:48.514869”,”current_ts”:”2018-05-31T11:49:54.481000”,”pos”:”00000000000000002373”,”before”:{“ID”:4,”IDD”:”7”},”after”:{“ID”:1,”IDD”:”7”}}</p>
<p>{“table”:”TCLOUD.T_OGG2”,”op_type”:”D”,”op_ts”:”2018-05-31 11:52:38.516877”,”current_ts”:”2018-05-31T11:52:45.633000”,”pos”:”00000000000000003161”,”before”:{“ID”:1,”IDD”:”7”}}<br>现在只有insert的数据是全的，update更新非主键字段before是没有数据的，更新主键before只有主键的数据，delete只有before的主键字段，也就是update和delete的信息是不全的，且没有主键信息（程序里是不能判断哪一个是主键的），这样对于程序自动解析同步数据是不利的（不同的需求可能不一样），具体自己可以分析，就不啰嗦了，这里主要解决，有需要before和after全部信息和主键信息的需求。</p>
<p>7.1 添加before</p>
<p>在源端extract里添加下面几行</p>
<p>GGSCI (ambari.master.com) 33&gt; edit param extkafka<br>GETUPDATEBEFORES<br>NOCOMPRESSDELETES<br>NOCOMPRESSUPDATES<br>重启 extkafka</p>
<p>stop extkafka<br>start extkafka<br>然后测试</p>
<p>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 14:48:55.630340”,”current_ts”:”2018-05-31T14:49:01.709000”,”pos”:”00000000000000003770”,”before”:{“ID”:1,”AGE”:20,”IDD”:”1”},”after”:{“ID”:1,”AGE”:1,”IDD”:”1”}}<br>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 14:48:55.630340”,”current_ts”:”2018-05-31T14:49:01.714000”,”pos”:”00000000000000004009”,”before”:{“ID”:1,”AGE”:20,”IDD”:”2”},”after”:{“ID”:1,”AGE”:1,”IDD”:”2”}}<br>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 14:48:55.630340”,”current_ts”:”2018-05-31T14:49:01.715000”,”pos”:”00000000000000004248”,”before”:{“ID”:1,”AGE”:20,”IDD”:”8”},”after”:{“ID”:1,”AGE”:1,”IDD”:”8”}}<br>发现update之后before里有数据即可，但是现在before和after的数据都不全（只有部分字段）</p>
<p>网上有的说只添加GETUPDATES即可，但我测试了没有成功，关于每个配置项什么含义可以参考<a href="https://blog.csdn.net/linucle/article/details/13505939（有些配置的含义里面也没有给出）" target="_blank" rel="noopener">https://blog.csdn.net/linucle/article/details/13505939（有些配置的含义里面也没有给出）</a><br>参考：<a href="http://www.itpub.net/thread-2083473-1-1.html" target="_blank" rel="noopener">http://www.itpub.net/thread-2083473-1-1.html</a></p>
<p>7.2 添加主键</p>
<p>在kafka.props添加</p>
<p>gg.handler.kafkahandler.format.includePrimaryKeys=true<br>重启 rekafka</p>
<p>stop rekafka<br>start rekafka<br>测试：</p>
<p>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 14:58:57.637035”,”current_ts”:”2018-05-31T14:59:03.401000”,”pos”:”00000000000000004510”,”primary_keys”:[“ID”,”IDD”],”before”:{“ID”:1,”AGE”:1,”IDD”:”1”},”after”:{“ID”:1,”AGE”:20,”IDD”:”1”}}<br>发现有primary_keys，不错~</p>
<p>参考：<a href="http://blog.51cto.com/lyzbg/2088409" target="_blank" rel="noopener">http://blog.51cto.com/lyzbg/2088409</a></p>
<p>7.3 补全全部字段</p>
<p>如果字段补全应该是Oracle没有开启全列补充日志</p>
<p>SQL&gt; select supplemental_log_data_all from v$database;  </p>
<h2 id="SUPPLE"><a href="#SUPPLE" class="headerlink" title="SUPPLE"></a>SUPPLE</h2><p>NO<br>通过以下命令开启</p>
<p>SQL&gt; alter database add supplemental log data(all) columns;</p>
<p>Database altered.</p>
<p>SQL&gt; select supplemental_log_data_all from v$database;</p>
<h2 id="SUPPLE-1"><a href="#SUPPLE-1" class="headerlink" title="SUPPLE"></a>SUPPLE</h2><p>YES</p>
<p>SQL&gt;<br>测试一下</p>
<p>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 15:27:45.655518”,”current_ts”:”2018-05-31T15:27:52.891000”,”pos”:”00000000000000006070”,”primary_keys”:[“ID”,”IDD”],”before”:{“ID”:1,”TEXT_NAME”:null,”AGE”:1,”ADD”:null,”IDD”:”1”},”after”:{“ID”:1,”TEXT_NAME”:null,”AGE”:20,”ADD”:null,”IDD”:”1”}}<br>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 15:27:45.655518”,”current_ts”:”2018-05-31T15:27:52.893000”,”pos”:”00000000000000006341”,”primary_keys”:[“ID”,”IDD”],”before”:{“ID”:1,”TEXT_NAME”:null,”AGE”:1,”ADD”:null,”IDD”:”2”},”after”:{“ID”:1,”TEXT_NAME”:null,”AGE”:20,”ADD”:null,”IDD”:”2”}}<br>{“table”:”TCLOUD.T_OGG2”,”op_type”:”U”,”op_ts”:”2018-05-31 15:27:45.655518”,”current_ts”:”2018-05-31T15:27:52.895000”,”pos”:”00000000000000006612”,”primary_keys”:[“ID”,”IDD”],”before”:{“ID”:1,”TEXT_NAME”:null,”AGE”:1,”ADD”:null,”IDD”:”8”},”after”:{“ID”:1,”TEXT_NAME”:null,”AGE”:20,”ADD”:null,”IDD”:”8”}}<br>到现在json信息里的内容已经很全了，基本满足了我想要的，附图：</p>
<p>启发我发现和Oracle全列补充日志没有开启有关的博客：<a href="https://blog.csdn.net/huoshuyinhua/article/details/79013387" target="_blank" rel="noopener">https://blog.csdn.net/huoshuyinhua/article/details/79013387</a><br>开启命令参考：<a href="https://blog.csdn.net/aaron8219/article/details/16825963" target="_blank" rel="noopener">https://blog.csdn.net/aaron8219/article/details/16825963</a></p>
<p>注：博客上讲到，开启全列补充日志会导致磁盘快速增长，LGWR进程繁忙，不建议使用。大家可根据自己的情况使用。</p>
<p>8、关于通配</p>
<p>如果想通配整个库的话，只需要把上面的配置所有表名的改为，如test_ogg.test_ogg改为 test_ogg.,但是kafka的topic不能通配，所以需要把所有的表的数据放在一个topic即可，后面再用程序解析表名即可。<br>9、附录</p>
<p>目标端在这里，下载下来后文件名123111_ggs_Adapters_Linux_x64.zip</p>
<p>源端在旧版本查询下载，下载后文件名为V34339-01.zip</p>
<p>参考资料</p>
<p><a href="https://www.cnblogs.com/purpleraintear/p/6071038.html" target="_blank" rel="noopener">基于OGG的Oracle与Hadoop集群准实时同步介绍</a></p>
</div><iframe src="/donate/?AliPayQR=/img/AliPayQR.png&amp;WeChatQR=/img/WeChatQR.png&amp;GitHub=null&amp;BTCQR=null&amp;BTCKEY=null&amp;PayPal=null" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>gaojintao999@163.com</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2019/07/08/测试文章/">https://gjtmaster.github.io/2019/07/08/测试文章/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>The author owns the copyright, please indicate the source reproduced.</li></ul></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://gjtmaster.github.io/2019/07/08/测试文章/" data-id="cjybkq6yd00036hd8nll3egj8" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACM0lEQVR42u3aQY7jMAwEwPz/015gr9l4ukXPApFKp2DGcVQ6EKTI1yte19/16S/X27r/1vuT7/99/cbCwMD4WsZ1uz79wBWv+UHcvxkDA+Mcxn2QzbeYbCV5Mt8bBgYGxv0z9yldkhomgRgDAwNjwpiUo3n4xsDAwJiXoO0RTNLKB2pxDAyML2S0jYH/+fkX+xsYGBhfwrjKNUkH8+Sy3hUGBsbWjHZUYp5KzqdCigwXAwNjI8Yk11prfOYtgcl1HgYGxk6MNlwmP9xepeXhNUoNMTAwNmLMy9dJoZukdw90NjAwMDZiTF7XXqVNqD8EXAwMjO0Ykx/Oy8sWnx8cBgbGCYx2Ky14VFvnYx8YGBhbM5KRiLwBkF/PrQ1k1KkhBgbGFoy1FuOkZM3HKZJjxcDAOIGRB9ykmGwTyrZgzgM0BgbGTow8ONbnMRi/SD7/IzXEwMA4jNEOfrWBtT2aHwI0BgbG1oz20v+pZkA+VFGUuBgYGAcw2tflW29TwyRYY2BgnMNoRx/aAa98K8nxffwLBgbGMYz20j/fUH19FjQ4o2ELDAyMLRhPDT0kaV87cvEAAAMDYwvGVa5iMCvgPVYAY2BgbM1og117KZZ/qx37wMDAOI2Rv7pNFtdSvcU9YGBgHMB4qoht8e0RfHwSAwMDY+n6PkeutR8WAy4GBsYBjKTBOQmya/vBwMA4gdEOXuQF6rMthMeu2zAwML6KMSkdk2ZA8ob2im1xaAMDA+P7GH8Ar19b0eW9mpQAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/java/">java</a><a href="/tags/scala/">scala</a></div><div class="post-nav"><a class="pre" href="/2019/07/20/hello-world/">Hello World</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/测试/">测试</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/scala/" style="font-size: 15px;">scala</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/20/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/08/测试文章/">测试文章</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://matt33.com/" title="Matt's Blog" target="_blank">Matt's Blog</a><ul></ul><a href="https://www.haomwei.com/technology/maupassant-hexo.html" title="Maupassant's usage" target="_blank">Maupassant's usage</a><ul></ul><a href="https://www.jianshu.com/p/f4332764e8bd" title="hexo's usage" target="_blank">hexo's usage</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Joker's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>